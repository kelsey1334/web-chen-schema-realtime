<!DOCTYPE html>
<html>
<head>
    <title>Schema Uploader</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body {font-family:sans-serif; background:#f6f7fb;}
        .container {max-width:580px; margin:40px auto; background:#fff; border-radius:8px; box-shadow:0 2px 12px #0001; padding:32px;}
        h2 {color:#10b981;}
        #log-box {height:200px;overflow:auto;border:1px solid #ddd;margin-top:10px;background:#f8f8f8;padding:8px;border-radius:4px;}
        button {background:#10b981;color:#fff;border:none;padding:10px 28px;font-size:16px;border-radius:6px;cursor:pointer;margin-top:10px;}
        button:hover {background:#0b8b6b;}
        .radio-group label {margin-right:24px;}
        #download {margin-top:16px;}
        .back {margin-bottom:18px; display:inline-block;}
        .back a {color:#194ca2; text-decoration:underline;}
    </style>
</head>
<body>
<div class="container">
    <div class="back"><a href="/dashboard">&larr; Quay về Dashboard</a></div>
    <h2>Upload & Gắn/Xoá Schema (Realtime Log)</h2>
    <form method="post" enctype="multipart/form-data">
        <div class="radio-group">
            <label><input type="radio" name="action" value="chencode" checked> Gắn Schema</label>
            <label><input type="radio" name="action" value="xoascript"> Xoá Schema</label>
        </div>
        <input type="file" name="file" accept=".xlsx" required>
        <button type="submit">Thực thi</button>
    </form>
    <div id="log-box"></div>
    <div id="download">
      {% if file_url %}
        <a href="{{ file_url }}" target="_blank">Tải kết quả</a>
      {% endif %}
    </div>
    {% if logs %}
      <div style="margin-top:14px;">
        <strong>Kết quả:</strong>
        <ul>
          {% for log in logs %}
            <li>{{ log }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
</div>
<script>
let ws = null;
function startWS() {
    const sessionId = "{{ session_id }}";
    ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws-upload/" + sessionId);
    ws.onmessage = function(event) {
        let logBox = document.getElementById('log-box');
        if (event.data === "DONE") {
            document.getElementById("download").innerHTML = "<b>Đã hoàn thành! F5 để lấy link tải kết quả nếu chưa có.</b>";
        } else {
            logBox.innerHTML += event.data + "<br>";
            logBox.scrollTop = logBox.scrollHeight;
        }
    }
}
startWS();
</script>
</body>
</html>
